{% extends "base.html" %}
{% block title %}Music — Hermes Radio{% endblock %}
{% block content %}
<h2>Music Library</h2>

<article>
    <header>Upload MP3</header>
    <form action="/admin/music/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="files" accept=".mp3,audio/mpeg" multiple required>
        <small>Select one or more .mp3 files (max 50 MB each)</small>
        <button type="submit">Upload</button>
    </form>
</article>

<article>
    <header>
        <div class="flex-between">
            <span id="track-count">
                {{ files|length }} track{{ 's' if files|length != 1 else '' }} in library ({{ total_size_mb }} MB)
            </span>
            <div class="flex-row">
                <button type="button" class="outline btn-sm" onclick="saveOrder()">
                    Save &amp; Reload
                </button>
                <form action="/admin/music/reload" method="post" class="m-0">
                    <button type="submit" class="outline secondary btn-sm">Force Reload</button>
                </form>
            </div>
        </div>
    </header>
    {% if files %}
    <div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Track</th>
                <th>Size</th>
                <th>Active</th>
                <th>Order</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="playlist-body">
            {% for f in files %}
            <tr data-filename="{{ f.name }}" draggable="true" class="{{ '' if f.enabled else 'disabled-track' }}">
                <td class="row-num">{{ loop.index }}</td>
                <td class="track-name">{{ f.name }}</td>
                <td>{{ f.size_mb }} MB</td>
                <td>
                    <form action="/admin/music/toggle" method="post" class="m-0">
                        <input type="hidden" name="filename" value="{{ f.name }}">
                        <input type="checkbox" role="switch" class="m-0"
                               {{ 'checked' if f.enabled else '' }}
                               onchange="this.form.submit()">
                    </form>
                </td>
                <td>
                    <div class="flex-row-tight">
                        <button type="button" class="outline secondary btn-xs" onclick="moveRow(this,-1)" title="Move up">&#9650;</button>
                        <button type="button" class="outline secondary btn-xs" onclick="moveRow(this,1)" title="Move down">&#9660;</button>
                    </div>
                </td>
                <td>
                    <form action="/admin/music/delete" method="post" class="inline-form"
                          onsubmit="return confirm('Delete {{ f.name }}?')">
                        <input type="hidden" name="filename" value="{{ f.name }}">
                        <button type="submit" class="outline secondary btn-xs btn-danger">&#10005;</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <small class="text-muted">Drag rows or use arrows to reorder. Toggle switch to include/exclude from playlist. Click "Save &amp; Reload" to apply.</small>
    {% else %}
    <p>No MP3 files yet. Upload some to get started.</p>
    {% endif %}
</article>
{% endblock %}

{% block scripts %}
<script>
const tbody = document.getElementById('playlist-body');
let dragRow = null;

tbody.addEventListener('dragstart', e => {
    dragRow = e.target.closest('tr');
    if (!dragRow) return;
    dragRow.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
});

tbody.addEventListener('dragend', e => {
    if (dragRow) dragRow.classList.remove('dragging');
    tbody.querySelectorAll('.drag-over').forEach(r => r.classList.remove('drag-over'));
    dragRow = null;
    renumber();
});

tbody.addEventListener('dragover', e => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const target = e.target.closest('tr');
    if (!target || target === dragRow) return;
    tbody.querySelectorAll('.drag-over').forEach(r => r.classList.remove('drag-over'));
    target.classList.add('drag-over');
});

tbody.addEventListener('dragleave', e => {
    const target = e.target.closest('tr');
    if (target) target.classList.remove('drag-over');
});

tbody.addEventListener('drop', e => {
    e.preventDefault();
    const target = e.target.closest('tr');
    if (!target || !dragRow || target === dragRow) return;
    target.classList.remove('drag-over');
    const rows = [...tbody.children];
    const dragIdx = rows.indexOf(dragRow);
    const targetIdx = rows.indexOf(target);
    if (dragIdx < targetIdx) {
        tbody.insertBefore(dragRow, target.nextSibling);
    } else {
        tbody.insertBefore(dragRow, target);
    }
    renumber();
});

function moveRow(btn, dir) {
    const row = btn.closest('tr');
    const rows = [...tbody.children];
    const idx = rows.indexOf(row);
    const newIdx = idx + dir;
    if (newIdx < 0 || newIdx >= rows.length) return;
    if (dir === -1) {
        tbody.insertBefore(row, rows[newIdx]);
    } else {
        tbody.insertBefore(row, rows[newIdx].nextSibling);
    }
    renumber();
}

function renumber() {
    tbody.querySelectorAll('.row-num').forEach((td, i) => td.textContent = i + 1);
}

function showToast(text, type) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = 'toast toast-' + (type || 'info');
    el.textContent = text;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

async function saveOrder() {
    const order = [...tbody.querySelectorAll('tr')].map(r => r.dataset.filename);
    const btn = document.querySelector('[onclick="saveOrder()"]');
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');
    btn.textContent = 'Saving...';

    try {
        const resp = await fetch('/admin/music/order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({order})
        });
        const data = await resp.json();
        showToast(data.liquidsoap
            ? `Playlist saved (${data.tracks} active tracks)`
            : `Playlist saved (${data.tracks} tracks) — Liquidsoap not connected`, 'success');
    } catch (err) {
        showToast('Error saving: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        btn.textContent = 'Save & Reload';
    }
}
</script>
{% endblock %}
