<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hermes Radio</title>
    <link rel="icon" href="{{ base }}/static/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="{{ base }}/static/style.css">
</head>
<body class="player-wrapper">
    <main class="container">
        <article class="player-card">
            <h1>Hermes Radio</h1>
            <p class="subtitle">24/7 AI-powered internet radio</p>

            <p id="status-line">
                <span class="status-dot loading" id="status-dot"></span>
                <span id="status-text">Checking...</span>
            </p>

            <div class="now-playing-strip" id="now-playing"></div>

            <audio id="audio" class="hidden"></audio>

            <div class="controls">
                <button id="btn-listen" onclick="togglePlay()">Listen</button>
            </div>

            <div id="volume-row">
                <span>Vol</span>
                <input type="range" id="volume" min="0" max="100" value="80" oninput="setVolume(this.value)">
                <span id="volume-label">80</span>
            </div>

            <div id="admin-controls" class="controls mt-2" style="display:none">
                <button id="btn-start" class="outline secondary btn-sm" onclick="startRadio()">Start Radio</button>
                <button id="btn-stop" class="outline secondary btn-sm" onclick="stopRadio()">Stop Radio</button>
            </div>

            <p id="admin-link" class="mt-2" style="display:none">
                <a href="{{ base }}/admin/" role="button" class="outline secondary btn-sm">Admin Panel</a>
            </p>
        </article>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script>
        const audio = document.getElementById('audio');
        const dot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const btnListen = document.getElementById('btn-listen');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const nowPlaying = document.getElementById('now-playing');
        let hls = null;
        let isPlaying = false;
        let radioRunning = false;
        let isAuthed = false;

        function setVolume(v) {
            audio.volume = v / 100;
            document.getElementById('volume-label').textContent = v;
            localStorage.setItem('hermes-vol', v);
        }

        // Restore saved volume
        const savedVol = localStorage.getItem('hermes-vol');
        if (savedVol) {
            document.getElementById('volume').value = savedVol;
            setVolume(savedVol);
        } else {
            setVolume(80);
        }

        function updateUI() {
            dot.className = 'status-dot ' + (radioRunning ? 'on' : 'off');
            statusText.textContent = radioRunning ? 'On Air' : 'Off Air';
            if (isAuthed) {
                btnStart.disabled = radioRunning;
                btnStop.disabled = !radioRunning;
            }
            btnListen.textContent = isPlaying ? 'Stop Listening' : 'Listen';
            btnListen.disabled = !radioRunning;
            if (!radioRunning && isPlaying) stopListening();
        }

        function attachHLS() {
            if (hls) { hls.destroy(); hls = null; }
            if (Hls.isSupported()) {
                hls = new Hls({
                    liveDurationInfinity: true,
                    enableWorker: true,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: 6,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    backBufferLength: 30,
                });
                hls.loadSource('{{ base }}/hls/radio.m3u8');
                hls.attachMedia(audio);
                hls.on(Hls.Events.ERROR, (_, data) => {
                    if (data.fatal) {
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            hls.startLoad();  // retry on network errors
                        } else {
                            isPlaying = false; updateUI();
                        }
                    }
                });
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = '{{ base }}/hls/radio.m3u8';
            }
        }

        function togglePlay() {
            if (isPlaying) { stopListening(); } else { startListening(); }
        }

        function startListening() {
            attachHLS();
            audio.play().then(() => { isPlaying = true; updateUI(); }).catch(() => {});
        }

        function stopListening() {
            audio.pause();
            if (hls) { hls.destroy(); hls = null; }
            isPlaying = false;
            updateUI();
        }

        async function startRadio() {
            btnStart.ariaBusy = 'true';
            dot.className = 'status-dot loading';
            statusText.textContent = 'Starting...';
            try {
                const res = await fetch('{{ base }}/api/playout/start', { method: 'POST' });
                if (res.status === 401 || res.redirected) {
                    statusText.textContent = 'Login required';
                    btnStart.ariaBusy = 'false';
                    return;
                }
                await new Promise(r => setTimeout(r, 6000));
            } catch(e) {}
            btnStart.ariaBusy = 'false';
            checkStatus();
        }

        async function stopRadio() {
            btnStop.ariaBusy = 'true';
            try {
                const res = await fetch('{{ base }}/api/playout/stop', { method: 'POST' });
                if (res.status === 401 || res.redirected) {
                    statusText.textContent = 'Login required';
                    btnStop.ariaBusy = 'false';
                    return;
                }
            } catch(e) {}
            btnStop.ariaBusy = 'false';
            radioRunning = false;
            updateUI();
        }

        async function checkStatus() {
            try {
                const res = await fetch('{{ base }}/api/playout/status');
                if (res.status !== 401) {
                    const data = await res.json();
                    radioRunning = data.running;
                    // If we can access playout status, show admin controls
                    if (!isAuthed) {
                        isAuthed = true;
                        document.getElementById('admin-controls').style.display = '';
                        document.getElementById('admin-link').style.display = '';
                    }
                } else {
                    radioRunning = false;
                }
            } catch(e) {
                radioRunning = false;
            }
            updateUI();
            updateNowPlaying();
        }

        async function updateNowPlaying() {
            try {
                const res = await fetch('{{ base }}/api/status/now-playing');
                const data = await res.json();
                const parts = [];
                if (data.tracks_since_last_break != null) parts.push(`Track ${data.tracks_since_last_break}`);
                if (data.quiet_mode) parts.push('Quiet mode');
                if (data.break_preparing) parts.push('Preparing break...');
                nowPlaying.textContent = parts.join(' \u00B7 ') || '';
            } catch(e) {
                nowPlaying.textContent = '';
            }
        }

        checkStatus();
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>
