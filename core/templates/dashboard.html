{% extends "base.html" %}
{% block title %}Dashboard â€” Hermes TV{% endblock %}
{% block content %}
<h2>Dashboard</h2>

<div class="stat-row" id="dashboard-stats"
     hx-get="{{ base }}/api/partials/dashboard-stats" hx-trigger="every 10s" hx-swap="outerHTML">
    <article class="stat-card">
        <div class="stat-value">{{ 'Active' if scheduler_running else 'Stopped' }}</div>
        <div class="stat-label">Scheduler</div>
        {% if scheduler_running %}
        <button class="btn-sm btn-danger" onclick="toggleScheduler('stop')">Stop</button>
        {% else %}
        <button class="btn-sm btn-success" onclick="toggleScheduler('start')">Start</button>
        {% endif %}
    </article>
    <article class="stat-card">
        <div class="stat-value">{{ breaks_played }}</div>
        <div class="stat-label">Breaks Played</div>
    </article>
    <article class="stat-card">
        <div class="stat-value">{{ breaks_failed }}</div>
        <div class="stat-label">Breaks Failed</div>
    </article>
    <article class="stat-card">
        <div class="stat-value">{{ 'ON' if quiet_mode else 'OFF' }}</div>
        <div class="stat-label">Quiet Mode</div>
    </article>
</div>

<div class="grid">
    <article id="last-break-card"
             hx-get="{{ base }}/api/partials/last-break" hx-trigger="every 10s" hx-swap="outerHTML">
        <header>Last Break</header>
        {% if last_break %}
        <p><strong>Host:</strong> {{ host_names.get(last_break.host_id, last_break.host_id) }}</p>
        <p><strong>Type:</strong> {{ last_break.type }}</p>
        <p><strong>Degradation:</strong> Level {{ last_break.degradation_level }}</p>
        <p><strong>Played:</strong> {{ last_break.played_at }}</p>
        {% if last_break.script_text %}
        <details>
            <summary>Script</summary>
            <p>{{ last_break.script_text }}</p>
        </details>
        {% endif %}
        {% else %}
        <p class="text-muted">No breaks played yet</p>
        {% endif %}
    </article>

    <article id="feed-health-card"
             hx-get="{{ base }}/api/partials/feed-health" hx-trigger="every 10s" hx-swap="outerHTML">
        <header>Feed Health</header>
        {% for status, count in feed_health.items() %}
        <p>
            <span class="badge badge-{{ 'ok' if status == 'healthy' else 'warn' if status == 'unhealthy' else 'err' }}">
                {{ status }}
            </span>
            {{ count }} feed{{ 's' if count != 1 else '' }}
        </p>
        {% else %}
        <p class="text-muted">No feeds configured</p>
        {% endfor %}
    </article>
</div>
{% endblock %}

{% block scripts %}
<style>
.btn-sm { padding: 4px 12px; font-size: 0.8rem; margin-top: 6px; border: none; border-radius: 4px; cursor: pointer; }
.btn-success { background: #22c55e; color: #fff; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-sm:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
<script>
async function toggleScheduler(action) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = action === 'start' ? 'Starting...' : 'Stopping...';
    try {
        const res = await fetch('{{ base }}/api/scheduler/' + action, {method: 'POST'});
        const data = await res.json();
        showToast('Scheduler ' + data.status, 'success');
        setTimeout(() => htmx.ajax('GET', '{{ base }}/api/partials/dashboard-stats', {target: '#dashboard-stats', swap: 'outerHTML'}), 500);
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
    }
}
</script>
{% endblock %}
